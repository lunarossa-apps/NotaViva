<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NotaViva — Riassunti & Meeting Mode</title>
  <meta name="description" content="App locale-first per riassunti, concetti chiave, flashcard e verbali riunione. Nessuna API."/>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <style>
    :root{
      --bg:#0f1220; --card:#171a2b; --muted:#9aa3b2; --text:#e9ecf1; --accent:#6ae3ff; --accent2:#a8ff60; --danger:#ff6a6a;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial;
      color:var(--text); background: radial-gradient(1200px 800px at 70% -10%, #1d2140 10%, transparent 60%), var(--bg); line-height:1.5; }
    header{max-width:1100px; margin:24px auto 8px; padding:0 16px; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:36px;height:36px}
    h1{font-size:20px; margin:0}
    .muted{color:var(--muted)}
    main{max-width:1100px; margin:0 auto; padding:16px}
    .grid{display:grid; grid-template-columns:1.1fr .9fr; gap:16px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }
    .card{background:linear-gradient(180deg, #1a1f36, #16192a); border:1px solid #242744; border-radius:var(--radius); padding:16px; box-shadow: 0 10px 24px rgba(0,0,0,.25)}
    textarea{ width:100%; min-height:220px; resize:vertical; padding:12px; border-radius:12px; border:1px solid #2a2e52; background:#101326; color:var(--text); outline:none; font-size:15px; }
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}
    .btn{ background:linear-gradient(180deg,#1e6dff,#3ec7ff); color:#001018; border:none; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; }
    .btn.secondary{background:#262a48; color:var(--text); border:1px solid #2d335c}
    .btn.danger{background:#3a1a1a; color:#ffd9d9; border:1px solid #6a2a2a}
    .btn.ghost{background:transparent; border:1px dashed #3a406e; color:var(--text)}
    select{ background:#101326; color:var(--text); border:1px solid #2a2e52; padding:8px 10px; border-radius:10px }
    label.slider{display:flex; gap:10px; align-items:center}
    input[type="range"]{width:180px}
    .pill{padding:4px 10px; border-radius:999px; background:#1d2040; border:1px solid #2a2d56; color:var(--accent)}
    .section-title{margin:0 0 10px; font-size:14px; letter-spacing:.4px; text-transform:uppercase; color:var(--muted)}
    ul.kv{display:flex; flex-wrap:wrap; gap:8px; padding:0; margin:0; list-style:none}
    ul.kv li{background:#12162a; border:1px solid #262a4e; padding:6px 10px; border-radius:999px}
    .list{display:flex; flex-direction:column; gap:10px; margin:0; padding:0; list-style:none}
    .list li{background:#12162a; border:1px solid #262a4e; padding:10px 12px; border-radius:12px}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 700px){ .two{grid-template-columns:1fr} }
    .savebar{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:10px}
    input[type="text"]{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2e52; background:#101326; color:var(--text); outline:none}
    .small{font-size:12px}
    footer{max-width:1100px; margin:20px auto 60px; padding:0 16px; color:var(--muted)}
    .chip{display:inline-flex; align-items:center; gap:6px; background:#0f1429; border:1px solid #242a50; padding:6px 10px; border-radius:999px}
    .empty{border:1px dashed #39406f; background:#0e1130; padding:16px; border-radius:12px; color:#9aa3b2}
    .copybar{display:flex; gap:8px; justify-content:flex-end; margin-top:6px}
    .svgbox{background:#0e1130; border:1px solid #2a2f5a; border-radius:12px; padding:8px; overflow:auto}
    .tabbar{display:flex; gap:8px; flex-wrap:wrap}
    .tabbar button{padding:8px 12px; border-radius:999px}
    .active{outline:2px solid #6ae3ff33}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img class="logo" src="favicon.svg" alt="logo"/>
      <div>
        <h1>NotaViva</h1>
        <div class="muted small" id="subtitle">Riassumi testi, estrai concetti, crea flashcard. Tutto offline.</div>
      </div>
    </div>
    <div class="row">
      <div class="chip"><span>Local-first</span><span>•</span><span>Nessuna API</span></div>
      <select id="langSel" title="Lingua">
        <option value="it">Italiano</option>
        <option value="en">English</option>
        <option value="es">Español</option>
        <option value="pt">Português</option>
        <option value="de">Deutsch</option>
      </select>
    </div>
  </header>

  <main class="grid">
    <!-- Standard Note Mode -->
    <section class="card">
      <div class="section-title" data-i="text">Testo</div>
      <textarea id="inputText" placeholder="Incolla qui il tuo testo..."></textarea>
      <div class="row" style="margin-top:10px">
        <label class="slider"><span data-i="sumlen">Lunghezza riassunto</span> <input id="ratio" type="range" min="10" max="60" step="5" value="30"><span class="pill"><span id="ratioVal">30</span>%</span></label>
        <button class="btn" id="analyzeBtn" data-i="analyze">Analizza</button>
        <button class="btn secondary" id="clearBtn" data-i="clear">Pulisci</button>
        <button class="btn secondary" id="sampleBtn" data-i="sample">Esempio</button>
      </div>
      <div class="savebar">
        <input type="text" id="titleInput" placeholder="Titolo nota (es. 'Riunione Q3', 'Capitolo 7')">
        <div class="row">
          <button class="btn secondary" id="exportBtn" data-i="export">Esporta .md</button>
          <button class="btn" id="saveBtn" data-i="save">Salva</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="two">
        <div>
          <div class="section-title" data-i="summary">Riassunto</div>
          <div id="summary" class="empty">Nessun risultato ancora. Premi “Analizza”.</div>
          <div class="copybar"><button class="btn ghost" id="copySummary" data-i="copy">Copia</button></div>
        </div>
        <div>
          <div class="section-title" data-i="keywords">Concetti chiave</div>
          <ul id="keywords" class="kv"></ul>
        </div>
      </div>
      <div class="two" style="margin-top:12px">
        <div>
          <div class="section-title" data-i="flashcards">Flashcard</div>
          <ul id="flashcards" class="list"></ul>
          <div class="copybar"><button class="btn ghost" id="copyFlash" data-i="copy">Copia</button></div>
        </div>
        <div>
          <div class="section-title" data-i="metrics">Metriche</div>
          <ul class="list">
            <li><strong data-i="length">Lunghezza</strong>: <span id="lenChars">0</span> <span data-i="chars">caratteri</span> • <span id="lenWords">0</span> <span data-i="words">parole</span></li>
            <li><strong data-i="readtime">Tempo di lettura</strong>: <span id="readTime">0 min</span></li>
            <li><strong>Sentiment</strong>: <span id="sentiment">–</span></li>
          </ul>
        </div>
      </div>
    </section>

    <section class="card" style="grid-column:1 / -1">
      <div class="section-title" data-i="saved">Note salvate (locale)</div>
      <div id="savedList" class="list"></div>
    </section>

    <!-- Meeting Mode -->
    <section class="card" style="grid-column:1 / -1">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="section-title">Meeting Mode</div>
        <div class="tabbar">
          <button class="btn secondary active" id="tabNotes" data-i="tab-notes">Note</button>
          <button class="btn secondary" id="tabOutcome" data-i="tab-outcome">Esito</button>
        </div>
      </div>
      <div id="meetingNotesBox">
        <textarea id="meetingText" placeholder="Prendi appunti liberi o incolla la trascrizione della riunione..."></textarea>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="analyzeMeet" data-i="analyzeMeeting">Analizza riunione</button>
          <button class="btn secondary" id="clearMeet" data-i="clear">Pulisci</button>
        </div>
      </div>
      <div id="meetingOutcomeBox" style="display:none">
        <div class="two">
          <div>
            <div class="section-title" data-i="meet-summary">Riassunto riunione</div>
            <div id="meetSummary" class="empty">—</div>
            <div class="copybar"><button class="btn ghost" id="copyMeetSummary" data-i="copy">Copia</button></div>
          </div>
          <div>
            <div class="section-title" data-i="meet-actions">Action items</div>
            <ul id="meetActions" class="list"></ul>
            <div class="copybar"><button class="btn ghost" id="copyMeetActions" data-i="copy">Copia</button></div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div class="section-title" data-i="mindmap">Mappa mentale</div>
          <div class="svgbox"><svg id="mindmapSVG" width="100%" height="420" viewBox="0 0 900 420"></svg></div>
          <div class="row" style="margin-top:8px">
            <button class="btn ghost" id="copyOutline" data-i="copy-outline">Copia outline</button>
            <button class="btn secondary" id="downloadSVG" data-i="download-svg">Scarica SVG</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="small" id="footNote">ⓘ Tutto resta sul tuo dispositivo. Perderai i dati se svuoti la cache del browser. — Made for Netlify static hosting.</div>
  </footer>

  <script>
    // I18N Dictionary
    const I18N = {
      it: {
        subtitle: "Riassumi testi, estrai concetti, crea flashcard. Tutto offline.",
        text: "Testo",
        sumlen: "Lunghezza riassunto",
        analyze: "Analizza",
        analyzeMeeting: "Analizza riunione",
        clear: "Pulisci",
        sample: "Esempio",
        export: "Esporta .md",
        save: "Salva",
        summary: "Riassunto",
        keywords: "Concetti chiave",
        flashcards: "Flashcard",
        metrics: "Metriche",
        length: "Lunghezza",
        chars: "caratteri",
        words: "parole",
        saved: "Note salvate (locale)",
        copy: "Copia",
        "tab-notes": "Note",
        "tab-outcome": "Esito",
        "meet-summary":"Riassunto riunione",
        "meet-actions":"Action items",
        mindmap:"Mappa mentale",
        "copy-outline":"Copia outline",
        "download-svg":"Scarica SVG",
        foot:"ⓘ Tutto resta sul tuo dispositivo. Perderai i dati se svuoti la cache del browser. — Made for Netlify static hosting.",
        placeholders: {
          input: "Incolla qui il tuo testo...",
          meeting: "Prendi appunti liberi o incolla la trascrizione della riunione...",
          title: "Titolo nota (es. 'Riunione Q3', 'Capitolo 7')"
        }
      },
      en: {
        subtitle: "Summarize text, extract key ideas, create flashcards. All offline.",
        text: "Text",
        sumlen: "Summary length",
        analyze: "Analyze",
        analyzeMeeting: "Analyze meeting",
        clear: "Clear",
        sample: "Sample",
        export: "Export .md",
        save: "Save",
        summary: "Summary",
        keywords: "Key concepts",
        flashcards: "Flashcards",
        metrics: "Metrics",
        length: "Length",
        chars: "chars",
        words: "words",
        saved: "Saved notes (local)",
        copy: "Copy",
        "tab-notes": "Notes",
        "tab-outcome": "Outcome",
        "meet-summary":"Meeting summary",
        "meet-actions":"Action items",
        mindmap:"Mind map",
        "copy-outline":"Copy outline",
        "download-svg":"Download SVG",
        foot:"ⓘ Everything stays on your device. Clearing browser data will remove notes. — Made for Netlify static hosting.",
        placeholders: {
          input: "Paste your text here...",
          meeting: "Take free-form notes or paste the meeting transcript...",
          title: "Note title (e.g., 'Q3 Meeting', 'Chapter 7')"
        }
      },
      es: {
        subtitle: "Resume textos, extrae ideas clave y crea fichas. Todo sin conexión.",
        text: "Texto",
        sumlen: "Longitud del resumen",
        analyze: "Analizar",
        analyzeMeeting: "Analizar reunión",
        clear: "Limpiar",
        sample: "Ejemplo",
        export: "Exportar .md",
        save: "Guardar",
        summary: "Resumen",
        keywords: "Conceptos clave",
        flashcards: "Flashcards",
        metrics: "Métricas",
        length: "Longitud",
        chars: "caracteres",
        words: "palabras",
        saved: "Notas guardadas (local)",
        copy: "Copiar",
        "tab-notes": "Notas",
        "tab-outcome": "Resultado",
        "meet-summary":"Resumen de la reunión",
        "meet-actions":"Puntos de acción",
        mindmap:"Mapa mental",
        "copy-outline":"Copiar esquema",
        "download-svg":"Descargar SVG",
        foot:"ⓘ Todo permanece en tu dispositivo. Al borrar datos del navegador, se eliminarán las notas.",
        placeholders: {
          input: "Pega aquí tu texto...",
          meeting: "Toma notas libres o pega la transcripción de la reunión...",
          title: "Título de la nota (p. ej., 'Reunión Q3')"
        }
      },
      pt: {
        subtitle: "Resuma textos, extraia conceitos e crie flashcards. Tudo offline.",
        text: "Texto",
        sumlen: "Tamanho do resumo",
        analyze: "Analisar",
        analyzeMeeting: "Analisar reunião",
        clear: "Limpar",
        sample: "Exemplo",
        export: "Exportar .md",
        save: "Salvar",
        summary: "Resumo",
        keywords: "Conceitos-chave",
        flashcards: "Flashcards",
        metrics: "Métricas",
        length: "Comprimento",
        chars: "caracteres",
        words: "palavras",
        saved: "Notas salvas (local)",
        copy: "Copiar",
        "tab-notes": "Notas",
        "tab-outcome": "Resultado",
        "meet-summary":"Resumo da reunião",
        "meet-actions":"Ações",
        mindmap:"Mapa mental",
        "copy-outline":"Copiar outline",
        "download-svg":"Baixar SVG",
        foot:"ⓘ Tudo fica no seu dispositivo. Limpar os dados do navegador remove as notas.",
        placeholders: {
          input: "Cole seu texto aqui...",
          meeting: "Faça anotações livres ou cole a transcrição...",
          title: "Título da nota (ex.: 'Reunião Q3')"
        }
      },
      de: {
        subtitle: "Text zusammenfassen, Kernideen extrahieren, Lernkarten erstellen. Alles offline.",
        text: "Text",
        sumlen: "Zusammenfassungslänge",
        analyze: "Analysieren",
        analyzeMeeting: "Meeting analysieren",
        clear: "Leeren",
        sample: "Beispiel",
        export: "Export .md",
        save: "Speichern",
        summary: "Zusammenfassung",
        keywords: "Schlüsselkonzepte",
        flashcards: "Karteikarten",
        metrics: "Metriken",
        length: "Länge",
        chars: "Zeichen",
        words: "Wörter",
        saved: "Gespeicherte Notizen (lokal)",
        copy: "Kopieren",
        "tab-notes": "Notizen",
        "tab-outcome": "Ergebnis",
        "meet-summary":"Meeting-Zusammenfassung",
        "meet-actions":"Aufgaben",
        mindmap:"Mindmap",
        "copy-outline":"Gliederung kopieren",
        "download-svg":"SVG herunterladen",
        foot:"ⓘ Alles bleibt auf deinem Gerät. Browserdaten löschen entfernt die Notizen.",
        placeholders: {
          input: "Füge hier deinen Text ein...",
          meeting: "Freie Notizen oder Meeting-Transkript einfügen...",
          title: "Notiztitel (z. B. 'Q3-Meeting')"
        }
      }
    };

    // Stopwords per language (minimal, extendable)
    const STOP = {
      it: new Set("a ad al alla alle ai agli col coi con contro da dal dallo dai dagli dalla delle di del dello dei degli della delle in nel nello nei negli nella nelle su sul sullo sui sugli sulla sulle per tra fra il lo la i gli le ed e o oppure che cui come anche ma però quindi se non più meno uno una un gli loro noi voi mio tua suo sua nostri vostre tuoi proprio stesso questa questo queste questi c è sono sia".split(/\s+/)),
      en: new Set("a an the and or but if then else for with at from into during including until against among between throughout despite towards upon of in on to by about as is are was were be been being this that these those it its their our your my me you he she they we".split(/\s+/)),
      es: new Set("a al del de la las los el en con por para como que si no más menos uno una unos unas y o pero aunque entre hacia desde sobre".split(/\s+/)),
      pt: new Set("a ao aos as o os de do da dos das em com por para como que se não mais menos um uma uns umas e ou mas entre desde sobre".split(/\s+/)),
      de: new Set("der die das ein eine eines einem einen und oder aber wenn dann sonst für mit bei von nach während einschließlich bis gegen unter zwischen trotz gegenüber auf aus in an zu über als ist sind war waren sein wurde".split(/\s+/))
    };

    const POS = {
      it: new Set("bene buono ottimo positivo crescita miglioramento successo facile chiaro utile vantaggio forte solido rapido meglio".split(' ')),
      en: new Set("good great excellent positive growth improvement success easy clear useful advantage strong solid better".split(' ')),
      es: new Set("bien bueno excelente positivo crecimiento mejora éxito fácil claro útil ventaja fuerte sólido mejor".split(' ')),
      pt: new Set("bem bom excelente positivo crescimento melhoria sucesso fácil claro útil vantagem forte sólido melhor".split(' ')),
      de: new Set("gut großartig ausgezeichnet positiv wachstum verbesserung erfolg einfach klar nützlich vorteil stark solide besser".split(' '))
    };
    const NEG = {
      it: new Set("male scarso pessimo negativo calo errore rischio difficile confuso inutile svantaggio debole fragile peggio ritardo problema".split(' ')),
      en: new Set("bad poor terrible negative decline error risk difficult confusing useless disadvantage weak fragile worse delay issue".split(' ')),
      es: new Set("mal pobre terrible negativo caída error riesgo difícil confuso inútil desventaja débil frágil peor retraso problema".split(' ')),
      pt: new Set("mal ruim terrível negativo queda erro risco difícil confuso inútil desvantagem fraco frágil pior atraso problema".split(' ')),
      de: new Set("schlecht arm furchtbar negativ rückgang fehler risiko schwierig verwirrend nutzlos nachteil schwach fragil schlimmer verzögerung problem".split(' '))
    };

    const UI = {
      setLang(lang){
        const L = I18N[lang] || I18N.it;
        document.getElementById('subtitle').textContent = L.subtitle;
        document.querySelectorAll('[data-i]').forEach(el=> el.textContent = L[el.dataset.i] || el.textContent);
        document.getElementById('inputText').placeholder = L.placeholders.input;
        document.getElementById('meetingText').placeholder = L.placeholders.meeting;
        document.getElementById('titleInput').placeholder = L.placeholders.title;
        document.getElementById('footNote').textContent = L.foot;
      }
    };

    // Helpers
    const $ = sel => document.querySelector(sel);
    function copyText(str){ navigator.clipboard.writeText(str).then(()=>{}, ()=>{}); }
    const ratioEl = $("#ratio"); const ratioVal = $("#ratioVal");
    ratioEl.addEventListener("input", ()=> ratioVal.textContent = ratioEl.value);

    function tokenizeSentences(text){
      return text.replace(/\s+/g,' ').split(/(?<=[\.!\?;:])\s+/).map(s=>s.trim()).filter(Boolean);
    }
    function tokenizeWords(text){
      return text.toLowerCase().match(/[\p{L}0-9']+/gu) || [];
    }

    // TextRank summarizer (language-agnostic, uses STOP by selected lang)
    let currentLang = localStorage.getItem('notaviva_lang') || 'it';
    $("#langSel").value = currentLang;
    UI.setLang(currentLang);

    $("#langSel").addEventListener('change', (e)=>{
      currentLang = e.target.value; localStorage.setItem('notaviva_lang', currentLang);
      UI.setLang(currentLang);
      renderSaved(); // keep labels consistent
    });

    function sentenceSimilarity(a,b){
      const wa = new Set(tokenizeWords(a).filter(w=>!STOP[currentLang]?.has(w)));
      const wb = new Set(tokenizeWords(b).filter(w=>!STOP[currentLang]?.has(w)));
      const inter = [...wa].filter(x=>wb.has(x)).length;
      if (inter === 0) return 0;
      return inter / (Math.log(wa.size+1)+Math.log(wb.size+1));
    }
    function buildGraph(sents){
      const n = sents.length;
      const g = Array.from({length:n}, ()=>Array(n).fill(0));
      for(let i=0;i<n;i++){
        for(let j=i+1;j<n;j++){
          const sim = sentenceSimilarity(sents[i], sents[j]);
          g[i][j]=g[j][i]=sim;
        }
      }
      return g;
    }
    function textRankScores(g, d=0.85, iters=40){
      const n = g.length;
      const s = Array(n).fill(1.0);
      for(let it=0; it<iters; it++){
        const ns = Array(n).fill((1-d));
        for(let i=0;i<n;i++){
          const sumW = g[i].reduce((a,b)=>a+b,0) || 1;
          for(let j=0;j<n;j++){
            if(i===j||g[i][j]===0) continue;
            ns[j] += d * (s[i] * g[i][j] / sumW);
          }
        }
        for(let k=0;k<n;k++) s[k]=ns[k];
      }
      return s;
    }
    function summarize(text, ratioPct){
      const sents = tokenizeSentences(text);
      if(sents.length<=2) return sents.join(" ");
      const g = buildGraph(sents);
      const scores = textRankScores(g);
      const pairs = sents.map((s,i)=>({i,s,score:scores[i]}));
      const take = Math.max(1, Math.round(sents.length * (ratioPct/100)));
      const top = pairs.sort((a,b)=>b.score-a.score).slice(0,take).sort((a,b)=>a.i-b.i);
      return top.map(p=>p.s).join(" ");
    }

    // RAKE-like keywords (use STOP by lang)
    function extractKeywords(text, max=12){
      const sw = STOP[currentLang] || STOP.it;
      const phrases = text
        .toLowerCase()
        .replace(/[\.,;:!?()\[\]{}"]/g,' ')
        .split(/\s+/)
        .map(w=>sw.has(w)?'|' : w)
        .join(' ')
        .split('|')
        .map(p=>p.trim())
        .filter(p=>p && p.length>1);

      const freq = new Map(), degree = new Map();
      for(const ph of phrases){
        const words = ph.split(/\s+/).filter(Boolean);
        const uniq = [...new Set(words)];
        for(const w of uniq){
          freq.set(w, (freq.get(w)||0)+1);
          degree.set(w, (degree.get(w)||0)+(words.length-1));
        }
      }
      const score = new Map();
      for(const [w,f] of freq){
        score.set(w, (degree.get(w)||0) + f);
      }
      const pscore = new Map();
      for(const ph of phrases){
        const words = ph.split(/\s+/).filter(Boolean);
        if(words.length===0) continue;
        let s=0; for(const w of words) s += (score.get(w)||0);
        pscore.set(ph, (pscore.get(ph)||0)+s);
      }
      const ranked = [...pscore.entries()].sort((a,b)=>b[1]-a[1]).slice(0,max).map(([p])=>p);
      return ranked.map(p=>p.split(' ').map(w=> w.length>2 ? w[0].toUpperCase()+w.slice(1) : w).join(' '));
    }

    // Flashcards
    function makeFlashcards(text, k=6){
      const sents = tokenizeSentences(text);
      const candidates = sents.filter(s=>s.length>40);
      const cards = [];
      const qT = {
        it: [ s=> "Qual è l'idea principale di: “"+s.slice(0,140)+"…”?",
              s=> "Perché è importante: “"+s.slice(0,140)+"…”?",
              s=> "Quale causa-effetto emerge da: “"+s.slice(0,140)+"…”?" ],
        en: [ s=> "What is the main idea of: “"+s.slice(0,140)+"…”?",
              s=> "Why is this important: “"+s.slice(0,140)+"…”?",
              s=> "What cause-effect emerges from: “"+s.slice(0,140)+"…”?" ],
        es: [ s=> "¿Cuál es la idea principal de: “"+s.slice(0,140)+"…”?",
              s=> "¿Por qué es importante: “"+s.slice(0,140)+"…”?",
              s=> "¿Qué relación causa-efecto surge de: “"+s.slice(0,140)+"…”?" ],
        pt: [ s=> "Qual é a ideia principal de: “"+s.slice(0,140)+"…”?",
              s=> "Por que isso é importante: “"+s.slice(0,140)+"…”?",
              s=> "Que relação de causa e efeito surge de: “"+s.slice(0,140)+"…”?" ],
        de: [ s=> "Was ist die Hauptidee von: “"+s.slice(0,140)+"…”?",
              s=> "Warum ist dies wichtig: “"+s.slice(0,140)+"…”?",
              s=> "Welche Ursache-Wirkung ergibt sich aus: “"+s.slice(0,140)+"…”?" ]
      }[currentLang] || [];
      for(let i=0;i<Math.min(k, candidates.length); i++){
        const s = candidates[i];
        const q = qT[i % qT.length] ? qT[i % qT.length](s) : ("Q: "+s.slice(0,120)+"…");
        cards.push({q, a: s});
      }
      return cards;
    }

    // Sentiment heuristic
    function sentiment(text){
      const w = tokenizeWords(text);
      const pset = POS[currentLang] || POS.it;
      const nset = NEG[currentLang] || NEG.it;
      let p=0,n=0; for(const t of w){ if(pset.has(t)) p++; if(nset.has(t)) n++; }
      if(p===0 && n===0) return "neutro";
      const s = p-n; if(s>1) return "positivo"; if(s<-1) return "negativo"; return "tendente al neutro";
    }

    // Save/Load
    function saveNote(title, raw, summary, keywords, cards){
      const store = JSON.parse(localStorage.getItem('notaviva')||'[]');
      const item = { id: Date.now(), title, raw, summary, keywords, cards, lang: currentLang, createdAt: new Date().toISOString() };
      store.unshift(item);
      localStorage.setItem('notaviva', JSON.stringify(store));
      renderSaved();
    }
    function renderSaved(){
      const L = I18N[currentLang]; const box = $("#savedList");
      const store = JSON.parse(localStorage.getItem('notaviva')||'[]');
      if(store.length===0){ box.innerHTML = '<div class="empty">Nessuna nota salvata.</div>'; return; }
      box.innerHTML = '';
      for(const it of store){
        const wrap = document.createElement('div'); wrap.className='card';
        const d = new Date(it.createdAt);
        wrap.innerHTML = \`
          <div class="row" style="justify-content:space-between; align-items:center">
            <div><strong>\${it.title||'Senza titolo'}</strong> <span class="muted small">• \${d.toLocaleString()}</span></div>
            <div class="row">
              <button class="btn secondary" data-id="\${it.id}" data-act="load">\${L.analyze||'Apri'}</button>
              <button class="btn danger" data-id="\${it.id}" data-act="del">Elimina</button>
            </div>
          </div>
        \`;
        box.appendChild(wrap);
      }
    }
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const act = btn.getAttribute('data-act'); if(!act) return;
      const id = +btn.getAttribute('data-id');
      const store = JSON.parse(localStorage.getItem('notaviva')||'[]');
      const idx = store.findIndex(x=>x.id===id);
      if(idx<0) return;
      if(act==='del'){
        if(confirm('Eliminare questa nota?')){
          store.splice(idx,1);
          localStorage.setItem('notaviva', JSON.stringify(store));
          renderSaved();
        }
      }else if(act==='load'){
        const it = store[idx];
        $('#titleInput').value = it.title||'';
        $('#inputText').value = it.raw||'';
        renderAll(it.raw, it.summary, it.keywords, it.cards);
        window.scrollTo({top:0, behavior:'smooth'});
      }
    });

    function renderAll(raw, summary, keywords, cards){
      $("#summary").textContent = summary || '';
      const kwEl = $("#keywords"); kwEl.innerHTML='';
      (keywords||[]).forEach(k=>{ const li=document.createElement('li'); li.textContent=k; kwEl.appendChild(li); });
      const fcEl = $("#flashcards"); fcEl.innerHTML='';
      (cards||[]).forEach(c=>{
        const li=document.createElement('li');
        li.innerHTML = '<strong>Q:</strong> '+c.q+'<br/><strong>A:</strong> '+c.a;
        fcEl.appendChild(li);
      });
      // metrics
      const words = tokenizeWords(raw);
      $("#lenChars").textContent = raw.length;
      $("#lenWords").textContent = words.length;
      $("#readTime").textContent = Math.max(1, Math.round(words.length/200)) + ' min';
      $("#sentiment").textContent = sentiment(raw);
    }

    // Handlers standard mode
    $("#analyzeBtn").addEventListener('click', ()=>{
      const text = $("#inputText").value.trim();
      if(!text){ alert("Incolla del testo da analizzare."); return; }
      const summary = summarize(text, +ratioEl.value);
      const keywords = extractKeywords(text, 14);
      const cards = makeFlashcards(text, 6);
      renderAll(text, summary, keywords, cards);
    });
    $("#clearBtn").addEventListener('click', ()=>{
      $("#inputText").value=''; $("#summary").textContent=''; $("#keywords").innerHTML=''; $("#flashcards").innerHTML='';
      $("#lenChars").textContent='0'; $("#lenWords").textContent='0'; $("#readTime").textContent='0 min'; $("#sentiment").textContent='–';
      $("#titleInput").value='';
    });
    $("#sampleBtn").addEventListener('click', ()=>{
      const samples = {
        it: "La trasformazione digitale sta accelerando in ogni settore. Le aziende che investono in automazione, dati e intelligenza artificiale ottengono vantaggi competitivi misurabili. Tuttavia, servono processi snelli e cultura della sperimentazione.",
        en: "Digital transformation is accelerating across industries. Companies investing in automation, data, and AI gain measurable advantages. However, lean processes and an experimentation culture are required.",
        es: "La transformación digital se acelera en todos los sectores. Las empresas que invierten en automatización, datos e IA logran ventajas medibles. Sin embargo, se requieren procesos ágiles y cultura de experimentación.",
        pt: "A transformação digital acelera em todos os setores. Empresas que investem em automação, dados e IA obtêm vantagens mensuráveis. Contudo, são necessários processos enxutos e cultura de experimentação.",
        de: "Die digitale Transformation beschleunigt sich in allen Branchen. Unternehmen, die in Automatisierung, Daten und KI investieren, erzielen messbare Vorteile. Allerdings braucht es schlanke Prozesse und eine Experimentierkultur."
      };
      $("#inputText").value = samples[currentLang] || samples.it;
    });
    $("#saveBtn").addEventListener('click', ()=>{
      const title = $("#titleInput").value.trim() || "Senza titolo";
      const raw = $("#inputText").value.trim();
      if(!raw){ alert("Nulla da salvare."); return; }
      const summary = $("#summary").textContent.trim();
      const keywords = [...$("#keywords").querySelectorAll('li')].map(li=>li.textContent);
      const cards = [...$("#flashcards").querySelectorAll('li')].map(li=>{
        const parts = li.innerHTML.split('<br>');
        const q = parts[0].replace(/<[^>]*>/g,'').replace(/^Q:\s*/,'').trim();
        const a = parts[1].replace(/<[^>]*>/g,'').replace(/^A:\s*/,'').trim();
        return {q,a};
      });
      saveNote(title, raw, summary, keywords, cards);
      alert("Salvato in locale.");
    });
    $("#exportBtn").addEventListener('click', ()=>{
      const title = ($("#titleInput").value.trim() || "NotaViva").replace(/[^a-z0-9-_]+/gi,'_');
      const raw = $("#inputText").value.trim();
      const summary = $("#summary").textContent.trim();
      const keywords = [...$("#keywords").querySelectorAll('li')].map(li=>li.textContent);
      const cards = [...$("#flashcards").querySelectorAll('li')].map(li=>{
        const parts = li.innerHTML.split('<br>');
        const q = parts[0].replace(/<[^>]*>/g,'').replace(/^Q:\s*/,'').trim();
        const a = parts[1].replace(/<[^>]*>/g,'').replace(/^A:\s*/,'').trim();
        return {q,a};
      });
      const md = [
        '# '+($("#titleInput").value||"NotaViva"),
        '',
        '## Summary',
        summary||'',
        '',
        '## Keywords',
        (keywords.map(k=>'- '+k).join('\n'))||'',
        '',
        '## Flashcards',
        (cards.map(c=>'- **Q**: '+c.q+'\n  **A**: '+c.a).join('\n')).trim(),
        '',
        '## Original text',
        raw
      ].join('\n');
      const blob = new Blob([md], {type:'text/markdown'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = title+'.md'; a.click();
      URL.revokeObjectURL(url);
    });
    // Copy buttons
    $("#copySummary").addEventListener('click', ()=> copyText($("#summary").textContent));
    $("#copyFlash").addEventListener('click', ()=>{
      const txt = [...$("#flashcards").querySelectorAll('li')].map(li=>li.innerText).join('\n\n');
      copyText(txt);
    });

    // Meeting Mode
    const tabNotes = $("#tabNotes"), tabOutcome = $("#tabOutcome");
    tabNotes.addEventListener('click', ()=>{
      tabNotes.classList.add('active'); tabOutcome.classList.remove('active');
      $("#meetingNotesBox").style.display='block'; $("#meetingOutcomeBox").style.display='none';
    });
    tabOutcome.addEventListener('click', ()=>{
      tabOutcome.classList.add('active'); tabNotes.classList.remove('active');
      $("#meetingNotesBox").style.display='none'; $("#meetingOutcomeBox").style.display='block';
    });

    function detectActions(text){
      const lang = currentLang;
      const sents = tokenizeSentences(text);
      const verbs = {
        it: ["definire","inviare","preparare","condividere","decidere","rivedere","allineare","presentare","stimare","concludere","aggiornare","schedulare","contattare","fornire","verificare"],
        en: ["define","send","prepare","share","decide","review","align","present","estimate","close","update","schedule","contact","provide","verify"],
        es: ["definir","enviar","preparar","compartir","decidir","revisar","alinear","presentar","estimar","cerrar","actualizar","programar","contactar","proveer","verificar"],
        pt: ["definir","enviar","preparar","compartilhar","decidir","revisar","alinhar","apresentar","estimar","fechar","atualizar","agendar","contatar","fornecer","verificar"],
        de: ["definieren","senden","vorbereiten","teilen","entscheiden","prüfen","abgleichen","präsentieren","schätzen","abschließen","aktualisieren","planen","kontaktieren","bereitstellen","verifizieren"]
      }[lang] || [];
      const hints = {
        it: ["entro","scadenza","deadline","oggi","domani"],
        en: ["by","deadline","today","tomorrow"],
        es: ["antes de","plazo","hoy","mañana"],
        pt: ["até","prazo","hoje","amanhã"],
        de: ["bis","frist","heute","morgen"]
      }[lang] || [];
      const items = [];
      for(const s of sents){
        const lw = tokenizeWords(s);
        const hasVerb = lw.some(w=>verbs.includes(w));
        const hasHint = lw.some(w=>hints.includes(w));
        if(hasVerb || hasHint || /@\w+/.test(s) || /\b\d{1,2}[\/.-]\d{1,2}(?:[\/.-]\d{2,4})?\b/.test(s)){
          items.push(s);
        }
      }
      return items.slice(0,20);
    }

    function buildMindMapSVG(center, keywords){
      const svg = $("#mindmapSVG");
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      const W=900,H=420,cx=W/2, cy=H/2;
      function el(tag, attrs){ const e=document.createElementNS('http://www.w3.org/2000/svg', tag); for(const k in attrs) e.setAttribute(k, attrs[k]); return e; }
      // central node
      svg.appendChild(el('circle',{cx, cy, r:60, fill:'#1a1f36', stroke:'#6ae3ff', 'stroke-width':3}));
      svg.appendChild(el('text',{x:cx, y:cy, 'text-anchor':'middle', 'dominant-baseline':'middle', fill:'#e9ecf1', 'font-size':'16'})).textContent=center.slice(0,40);
      const R=150;
      const n = Math.min(10, keywords.length);
      for(let i=0;i<n;i++){
        const angle = (i/n) * Math.PI*2;
        const x = cx + Math.cos(angle)*R;
        const y = cy + Math.sin(angle)*R;
        // line
        svg.appendChild(el('line',{x1:cx, y1:cy, x2:x, y2:y, stroke:'#2a2e52', 'stroke-width':2}));
        // node
        svg.appendChild(el('circle',{cx:x, cy:y, r:42, fill:'#12162a', stroke:'#a8ff60', 'stroke-width':2}));
        const t = keywords[i].slice(0,18);
        const text = el('text',{x:x, y:y, 'text-anchor':'middle', 'dominant-baseline':'middle', fill:'#e9ecf1', 'font-size':'13'});
        text.textContent=t; svg.appendChild(text);
      }
    }

    function outlineFromKeywords(title, keywords, actions){
      const lines = [];
      lines.push('* '+title);
      lines.push('  * Keywords:');
      for(const k of keywords) lines.push('    * '+k);
      if(actions && actions.length){
        lines.push('  * Action items:');
        for(const a of actions) lines.push('    * '+a);
      }
      return lines.join('\n');
    }

    $("#analyzeMeet").addEventListener('click', ()=>{
      const text = $("#meetingText").value.trim();
      if(!text){ alert("Aggiungi qualche nota della riunione."); return; }
      const title = ($("#titleInput").value.trim() || "Riunione");
      const sum = summarize(text, 30);
      const acts = detectActions(text);
      const kws = extractKeywords(text, 8);
      $("#meetSummary").textContent = sum || '—';
      const ul = $("#meetActions"); ul.innerHTML='';
      if(acts.length===0){
        const li = document.createElement('li'); li.textContent = 'Nessun action item rilevato.'; ul.appendChild(li);
      }else{
        for(const a of acts){ const li=document.createElement('li'); li.textContent=a; ul.appendChild(li); }
      }
      buildMindMapSVG(title, kws);
      $("#copyMeetSummary").onclick = ()=> copyText(sum);
      $("#copyMeetActions").onclick = ()=> copyText(acts.join('\n'));
      const outline = outlineFromKeywords(title, kws, acts);
      $("#copyOutline").onclick = ()=> copyText(outline);
      $("#downloadSVG").onclick = ()=>{
        const svgEl = document.getElementById('mindmapSVG');
        const src = new XMLSerializer().serializeToString(svgEl);
        const blob = new Blob([src], {type:'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=(title.replace(/[^a-z0-9-_]+/gi,'_')||'mindmap')+'.svg'; a.click();
        URL.revokeObjectURL(url);
      };
      // Switch to outcome tab automatically
      tabOutcome.click();
    });

    $("#clearMeet").addEventListener('click', ()=>{ $("#meetingText").value=''; $("#meetSummary").textContent='—'; $("#meetActions").innerHTML=''; buildMindMapSVG('',[]); });

    // Initial render
    renderSaved();
  </script>
</body>
</html>
